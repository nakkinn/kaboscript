# 高水準言語仕様

VM上で動作する高水準言語の仕様。クラスなし、型は `int` のみ。文字・文字列は今後実装予定。

## プログラム構造

トップレベルには**関数定義**と**変数宣言**のみ記述できる。関数内で関数を定義することはできない。

```
var counter;
var table[64];

function add(a, b){
    return a + b;
}

function main(){
    counter = add(1, 2);
    return 0;
}
```

- `main` が自動的に呼び出されるエントリーポイントとなる。
- トップレベルの宣言順序は自由。後方で定義された関数・変数も参照できる（コンパイラが2パスで解決する）。

## 型

| 型 | 説明 |
|---|---|
| `int` | 整数型。唯一のデータ型 |
| `char` | 未実装 |
| `string` | 未実装 |

真偽値のリテラル（`true`/`false`/`null`）はない。`0`/`1` で代用する。

## 関数定義

全て `function` キーワードで定義する。常に `return expr;` で値を返す。

```
function add(a, b){
    return a + b;
}
```

- `return expr;` が必須。return文がない場合はコンパイルエラー。
- 戻り値を使わない関数は慣習として `return 0;` で終わる。
- 文として呼び出した場合（`add(1, 2);`）、戻り値は暗黙的に捨てられる（VMレベルで `pop temp 0`）。

### 引数

- 引数に型名は付けない。全て `int` として扱う。
- 配列とスカラーの区別はない。配列はアドレスとして渡される。

```
function sum(arr, len){
    var total = 0;
    for(var i = 0; i < len; i++){
        total += arr[i];
    }
    return total;
}
```

## 変数宣言

### グローバル変数

トップレベルに記述する。VMの `static` セグメントにマッピングされる。

```
var count;
var buf[128];
var limit = 100;
```

- ゼロ初期化がデフォルト。
- 定数式による初期化も可能（`var x = 10;`）。
- 全ての関数からアクセスできる。

### ローカル変数

関数内で宣言する。VMの `local` セグメントにマッピングされる。

```
function example(){
    var x;
    var y = 10;
    var arr[5];
    // ...
}
```

- ブロック内での宣言も可能。スコープはそのブロック内に限定される。
- ブロックを抜けるとスロットは再利用される（ウォーターマーク方式）。
- 使用する前に宣言が必要。前方参照は不可。

```
function scoping(){ // return 省略
    var x = 1;
    if(x == 1){
        var y = 2;      // ブロックスコープ
    }
    // y はここでは使用不可
}
```

## 変数代入

```
x = expr;
x++;
x--;
x += expr;
x -= expr;
x *= expr;
```

## 制御構文

### if-else

```
if(x > 0){
    // ...
}else{
    // ...
}
```

ブロック `{}` を省略して単文も可。

### while

```
while(x > 0){
    x--;
}
```

### for

```
for(var i = 0; i < 10; i++){
    // ...
}
```

初期化・条件・更新はそれぞれ省略可。

## 演算子

### 優先順位（上が高い）

| 優先順位 | 演算子 | 結合性 |
|---|---|---|
| 1 | `()` `[]` | 左 |
| 2 | `-`(単項) `+`(単項) `!` | 右 |
| 3 | `*` `/` | 左 |
| 4 | `+` `-` | 左 |
| 5 | `<` `>` `<=` `>=` | 左 |
| 6 | `==` `!=` | 左 |
| 7 | `&&` | 左 |
| 8 | `||` | 左 |

注: `/` は未実装。

### 算術

| 演算子 | 説明 |
|---|---|
| `+` | 加算 |
| `-` | 減算 |
| `*` | 乗算 |
| `/` | 除算（未実装） |

### 比較

| 演算子 | 説明 |
|---|---|
| `==` | 等価 |
| `!=` | 非等価 |
| `<` | 小なり |
| `>` | 大なり |
| `<=` | 以下 |
| `>=` | 以上 |

### 論理

| 演算子 | 説明 |
|---|---|
| `&&` | 論理AND |
| `\|\|` | 論理OR |
| `!` | 論理NOT |

### 単項

| 演算子 | 説明 |
|---|---|
| `-` | 符号反転 |
| `+` | 恒等（何もしない） |

## 配列

ヒープ上に確保される。ローカル変数にはアドレスのみ保持する。VMの `alloc` でメモリを確保する。

```
var arr[10];        // alloc(10) → アドレスをローカルに格納
arr[3] = 100;       // 書き込み
var x = arr[3];     // 読み出し
```

## 組み込み関数

コンパイラが特別扱いし、VMの命令に直接変換する。通常の関数と同じ構文で呼び出す。

| 関数 | 動作 | VM命令 |
|---|---|---|
| `print(expr)` | 式の値を数値として出力し、空白を追加 | `push argument 0` → `out` → `outsp` |
| `newline()` | 改行を出力 | `outnl` |

## コメント

```
// 行コメント

/* ブロックコメント
   複数行可 */
```

## コード例

### フィボナッチ数列

```
function fib(n){
    if(n <= 1){
        return n;
    }
    return fib(n - 1) + fib(n - 2);
}

function main(){
    var i = 0;
    while(i < 10){
        print(fib(i));
        i++;
    }
    newline();
    return 0;
}
```

### FizzBuzz

```
function fizzbuzz(n){
    var i = 1;
    while(i <= n){
        if(i % 15 == 0){
            print(0);
        }else if(i % 3 == 0){
            print(3);
        }else if(i % 5 == 0){
            print(5);
        }else{
            print(i);
        }
        i++;
    }
    newline();
    return 0;
}

function main(){
    fizzbuzz(20);
    return 0;
}
```
